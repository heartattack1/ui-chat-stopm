<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Simple STOMP Chat</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background: #f6f6f6;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      background: #fff;
      border: 1px solid #ddd;
      padding: 16px;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .status {
      font-size: 0.9rem;
      color: #555;
    }
    .main {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 12px;
    }
    .messages {
      border: 1px solid #ddd;
      background: #fafafa;
      height: 360px;
      overflow-y: auto;
      padding: 10px;
    }
    .message {
      padding: 6px 0;
      border-bottom: 1px solid #eee;
    }
    .message:last-child {
      border-bottom: none;
    }
    .meta {
      font-size: 0.8rem;
      color: #777;
    }
    .participants {
      border: 1px solid #ddd;
      background: #fafafa;
      padding: 10px;
      height: 360px;
      overflow-y: auto;
    }
    .input-row {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }
    .input-row input {
      flex: 1;
      padding: 8px;
    }
    .input-row button {
      padding: 8px 12px;
    }
    .nickname {
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div>
        <div>Одноимённый канал</div>
        <div class="status" id="status">Статус: отключено</div>
      </div>
      <div>
        <span class="nickname" id="nickname">...</span>
        <button id="logoutBtn">Logout</button>
      </div>
    </div>

    <div class="main">
      <div>
        <div class="messages" id="messages"></div>
        <form class="input-row" id="messageForm">
          <input type="text" id="messageInput" placeholder="Сообщение" autocomplete="off" />
          <button type="submit">Send</button>
        </form>
      </div>
      <div>
        <div>Участники</div>
        <div class="participants" id="participants"></div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
  <script>
    (function () {
      const statusEl = document.getElementById('status');
      const messagesEl = document.getElementById('messages');
      const participantsEl = document.getElementById('participants');
      const messageForm = document.getElementById('messageForm');
      const messageInput = document.getElementById('messageInput');
      const nicknameEl = document.getElementById('nickname');
      const logoutBtn = document.getElementById('logoutBtn');

      const tokenStore = {
        accessToken: localStorage.getItem('access_token') || '',
        refreshToken: localStorage.getItem('refresh_token') || ''
      };

      function decodeJwt(token) {
        try {
          const payload = token.split('.')[1];
          const json = atob(payload.replace(/-/g, '+').replace(/_/g, '/'));
          return JSON.parse(decodeURIComponent(escape(json)));
        } catch (error) {
          return null;
        }
      }

      function resolveNickname(token) {
        const payload = decodeJwt(token) || {};
        return payload.preferred_username || payload.name || payload.sub || 'user';
      }

      function setStatus(text) {
        statusEl.textContent = `Статус: ${text}`;
      }

      function renderMessage({ author, content, timestamp }) {
        const item = document.createElement('div');
        item.className = 'message';
        const time = new Date(timestamp).toLocaleTimeString();
        item.innerHTML = `
          <div>${author}: ${content}</div>
          <div class="meta">${time}</div>
        `;
        messagesEl.appendChild(item);
        messagesEl.scrollTop = messagesEl.scrollHeight;
      }

      function renderParticipants(list) {
        participantsEl.innerHTML = '';
        list.forEach((name) => {
          const item = document.createElement('div');
          item.textContent = name;
          participantsEl.appendChild(item);
        });
      }

      const ChatSocketService = (function () {
        const maxReconnectAttempts = 5;
        const baseDelay = 1000;
        let reconnectAttempts = 0;
        let stompClient = null;
        let sock = null;
        let connecting = false;
        let manualClose = false;

        function connect() {
          if (connecting || manualClose) {
            return;
          }
          connecting = true;
          setStatus('подключение...');
          sock = new SockJS('/ws');
          stompClient = Stomp.over(sock);
          stompClient.debug = null;

          const headers = {
            Authorization: `Bearer ${tokenStore.accessToken}`
          };

          sock.onclose = (event) => {
            if (manualClose) {
              return;
            }
            if (event && event.code === 1008) {
              handleAuthError();
              return;
            }
            scheduleReconnect();
          };

          stompClient.connect(
            headers,
            () => {
              connecting = false;
              reconnectAttempts = 0;
              setStatus('подключено');
              stompClient.subscribe('/topic/chat', (message) => {
                const body = JSON.parse(message.body);
                renderMessage(body);
              });
              stompClient.subscribe('/topic/participants', (message) => {
                const list = JSON.parse(message.body);
                renderParticipants(list);
              });
            },
            (errorFrame) => {
              connecting = false;
              const errorMessage = errorFrame && errorFrame.headers && errorFrame.headers.message;
              if (errorMessage && errorMessage.toLowerCase().includes('unauthorized')) {
                handleAuthError();
                return;
              }
              scheduleReconnect();
            }
          );
        }

        function scheduleReconnect() {
          if (reconnectAttempts >= maxReconnectAttempts) {
            setStatus('ошибка подключения');
            return;
          }
          const delay = baseDelay * Math.pow(2, reconnectAttempts);
          reconnectAttempts += 1;
          setStatus(`переподключение через ${delay / 1000}с`);
          setTimeout(connect, delay);
        }

        function disconnect() {
          manualClose = true;
          if (stompClient) {
            stompClient.disconnect(() => {
              setStatus('отключено');
            });
          }
        }

        function sendMessage(content, author) {
          if (!stompClient || !stompClient.connected) {
            setStatus('нет соединения');
            return;
          }
          const payload = {
            author,
            content,
            timestamp: new Date().toISOString()
          };
          try {
            stompClient.send('/app/chat.send', {}, JSON.stringify(payload));
          } catch (error) {
            handleAuthError();
          }
        }

        function handleAuthError() {
          setStatus('обновление токена');
          refreshToken()
            .then((newToken) => {
              tokenStore.accessToken = newToken;
              localStorage.setItem('access_token', newToken);
              manualClose = false;
              connect();
            })
            .catch(() => {
              setStatus('нужно перелогиниться');
            });
        }

        function refreshToken() {
          return fetch('/auth/refresh', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ refreshToken: tokenStore.refreshToken })
          })
            .then((response) => {
              if (!response.ok) {
                throw new Error('Refresh failed');
              }
              return response.json();
            })
            .then((data) => {
              return data.accessToken || data.token || '';
            });
        }

        function clearTokens() {
          tokenStore.accessToken = '';
          tokenStore.refreshToken = '';
          localStorage.removeItem('access_token');
          localStorage.removeItem('refresh_token');
        }

        return {
          connect,
          disconnect,
          sendMessage,
          clearTokens
        };
      })();

      const nickname = resolveNickname(tokenStore.accessToken);
      nicknameEl.textContent = nickname;

      messageForm.addEventListener('submit', (event) => {
        event.preventDefault();
        const content = messageInput.value.trim();
        if (!content) {
          return;
        }
        ChatSocketService.sendMessage(content, nickname);
        messageInput.value = '';
      });

      logoutBtn.addEventListener('click', () => {
        ChatSocketService.disconnect();
        ChatSocketService.clearTokens();
        setStatus('отключено');
      });

      ChatSocketService.connect();
    })();
  </script>
</body>
</html>
