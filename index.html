<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Simple STOMP Chat</title>
  <style>
  /* ====== Claude/OpenCode-ish geek theme ====== */
  :root {
    --bg: #0b0f14;
    --panel: #0f1621;
    --panel-2: #0c121b;
    --border: rgba(255, 255, 255, 0.10);
    --border-strong: rgba(255, 255, 255, 0.16);

    --text: rgba(255, 255, 255, 0.92);
    --muted: rgba(255, 255, 255, 0.62);
    --faint: rgba(255, 255, 255, 0.42);

    --accent: #66e3ff;   /* cyan */
    --accent-2: #a78bfa; /* violet */
    --good: #34d399;
    --warn: #fbbf24;
    --bad: #fb7185;

    --shadow: 0 12px 40px rgba(0, 0, 0, 0.55);
    --radius: 16px;
  }

  /* Font stack: modern UI + mono accents (no external fetch required) */
  body {
    margin: 0;
    padding: 24px;
    color: var(--text);
    background:
      radial-gradient(1000px 600px at 15% -10%, rgba(102, 227, 255, 0.14), transparent 60%),
      radial-gradient(900px 500px at 95% 0%, rgba(167, 139, 250, 0.12), transparent 55%),
      linear-gradient(180deg, var(--bg), #070a0f 70%);
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    letter-spacing: 0.2px;
  }

  /* Nice monospace option for small UI bits */
  .mono, .status, .meta, .nickname, button, input {
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  }

  .container {
    max-width: 980px;
    margin: 0 auto;
    background: linear-gradient(180deg, rgba(15, 22, 33, 0.92), rgba(12, 18, 27, 0.92));
    border: 1px solid var(--border);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    padding: 18px;
    backdrop-filter: blur(10px);
  }

  .header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 12px;
    margin-bottom: 14px;
    padding-bottom: 12px;
    border-bottom: 1px solid var(--border);
  }

  .header > div:first-child > div:first-child {
    font-weight: 650;
    font-size: 1.05rem;
    letter-spacing: 0.3px;
  }

  .status {
    margin-top: 6px;
    font-size: 0.82rem;
    color: var(--muted);
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 6px 10px;
    border: 1px solid var(--border);
    border-radius: 999px;
    background: rgba(255, 255, 255, 0.03);
  }

  /* Status dot (no JS changes; we style via text heuristics below) */
  .status::before {
    content: "";
    width: 8px;
    height: 8px;
    border-radius: 999px;
    background: var(--warn);
    box-shadow: 0 0 0 3px rgba(251, 191, 36, 0.14);
  }

  /* If status text contains key words, colorize dot */
  #status[data-state="ok"]::before { background: var(--good); box-shadow: 0 0 0 3px rgba(52, 211, 153, 0.14); }
  #status[data-state="bad"]::before { background: var(--bad);  box-shadow: 0 0 0 3px rgba(251, 113, 133, 0.14); }

  .nickname {
    font-weight: 700;
    color: rgba(255, 255, 255, 0.88);
    padding: 6px 10px;
    border: 1px solid var(--border);
    border-radius: 999px;
    background: rgba(255, 255, 255, 0.03);
    margin-right: 10px;
  }

  .main {
    display: grid;
    grid-template-columns: 2.2fr 1fr;
    gap: 14px;
  }

  /* Panels */
  .messages,
  .participants {
    border: 1px solid var(--border);
    background: linear-gradient(180deg, rgba(255, 255, 255, 0.03), rgba(255, 255, 255, 0.015));
    border-radius: 14px;
    box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.04);
    overflow: hidden;
  }

  .messages {
    height: 380px;
    overflow-y: auto;
    padding: 12px 12px 10px;
  }

  .participants {
    height: 380px;
    overflow-y: auto;
    padding: 12px;
  }

  /* Section title for participants */
  .main > div:last-child > div:first-child {
    font-size: 0.9rem;
    color: var(--muted);
    margin: 2px 0 10px 4px;
    letter-spacing: 0.2px;
  }

  /* Messages */
  .message {
    padding: 10px 10px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.06);
    border-radius: 10px;
    margin-bottom: 6px;
    background: rgba(0, 0, 0, 0.14);
  }

  .message:last-child {
    border-bottom: none;
    margin-bottom: 0;
  }

  .message > div:first-child {
    line-height: 1.35;
    color: rgba(255, 255, 255, 0.90);
    word-break: break-word;
  }

  .message > div:first-child strong,
  .message > div:first-child b {
    color: var(--accent);
  }

  .meta {
    margin-top: 6px;
    font-size: 0.78rem;
    color: var(--faint);
  }

  /* Participants list items */
  #participants > div {
    padding: 8px 10px;
    border: 1px solid rgba(255, 255, 255, 0.06);
    border-radius: 12px;
    background: rgba(0, 0, 0, 0.12);
    margin-bottom: 8px;
    color: rgba(255, 255, 255, 0.84);
  }

  #participants > div:last-child {
    margin-bottom: 0;
  }

  /* Input row */
  .input-row {
    display: flex;
    gap: 10px;
    margin-top: 12px;
    align-items: center;
  }

  .input-row input {
    flex: 1;
    padding: 12px 12px;
    border-radius: 12px;
    border: 1px solid var(--border);
    background: rgba(0, 0, 0, 0.22);
    color: var(--text);
    outline: none;
    transition: border-color 160ms ease, box-shadow 160ms ease, background 160ms ease;
  }

  .input-row input::placeholder {
    color: rgba(255, 255, 255, 0.38);
  }

  .input-row input:focus {
    border-color: rgba(102, 227, 255, 0.45);
    box-shadow: 0 0 0 4px rgba(102, 227, 255, 0.12);
    background: rgba(0, 0, 0, 0.28);
  }

  /* Buttons */
  button {
    padding: 11px 14px;
    border-radius: 12px;
    border: 1px solid var(--border);
    background: rgba(255, 255, 255, 0.04);
    color: rgba(255, 255, 255, 0.88);
    cursor: pointer;
    transition: transform 120ms ease, border-color 160ms ease, background 160ms ease, box-shadow 160ms ease;
    user-select: none;
  }

  button:hover {
    background: rgba(255, 255, 255, 0.06);
    border-color: var(--border-strong);
    box-shadow: 0 8px 22px rgba(0, 0, 0, 0.35);
  }

  button:active {
    transform: translateY(1px);
  }

  /* Primary action: Send button (by form context) */
  #messageForm button[type="submit"] {
    border-color: rgba(102, 227, 255, 0.28);
    background:
      linear-gradient(180deg, rgba(102, 227, 255, 0.18), rgba(102, 227, 255, 0.08));
  }

  #messageForm button[type="submit"]:hover {
    border-color: rgba(102, 227, 255, 0.45);
    box-shadow: 0 10px 26px rgba(102, 227, 255, 0.10);
  }

  /* Logout: danger-ish */
  #logoutBtn {
    border-color: rgba(251, 113, 133, 0.22);
    background: rgba(251, 113, 133, 0.06);
  }

  #logoutBtn:hover {
    border-color: rgba(251, 113, 133, 0.40);
    box-shadow: 0 10px 26px rgba(251, 113, 133, 0.10);
  }

  /* Scrollbars (WebKit) */
  .messages::-webkit-scrollbar,
  .participants::-webkit-scrollbar {
    width: 10px;
  }

  .messages::-webkit-scrollbar-track,
  .participants::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.02);
    border-left: 1px solid rgba(255, 255, 255, 0.06);
  }

  .messages::-webkit-scrollbar-thumb,
  .participants::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.10);
    border: 2px solid rgba(0, 0, 0, 0);
    background-clip: padding-box;
    border-radius: 999px;
  }

  .messages::-webkit-scrollbar-thumb:hover,
  .participants::-webkit-scrollbar-thumb:hover {
    background: rgba(255, 255, 255, 0.16);
    border: 2px solid rgba(0, 0, 0, 0);
    background-clip: padding-box;
  }

  /* Responsive */
  @media (max-width: 860px) {
    body { padding: 14px; }
    .container { padding: 14px; }
    .main { grid-template-columns: 1fr; }
    .messages, .participants { height: 320px; }
    .header { flex-direction: column; align-items: flex-start; }
  }
</style>

</head>
<body>
  <div class="container">
    <div class="header">
      <div>
        <div>Одноимённый канал</div>
        <div class="status" id="status">Статус: отключено</div>
      </div>
      <div>
        <span class="nickname" id="nickname">...</span>
        <button id="logoutBtn">Logout</button>
      </div>
    </div>

    <div class="main">
      <div>
        <div class="messages" id="messages"></div>
        <form class="input-row" id="messageForm">
          <input type="text" id="messageInput" placeholder="Сообщение" autocomplete="off" />
          <button type="submit">Send</button>
        </form>
      </div>
      <div>
        <div>Участники</div>
        <div class="participants" id="participants"></div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
  <script>
    (function () {
      const statusEl = document.getElementById('status');
      const messagesEl = document.getElementById('messages');
      const participantsEl = document.getElementById('participants');
      const messageForm = document.getElementById('messageForm');
      const messageInput = document.getElementById('messageInput');
      const nicknameEl = document.getElementById('nickname');
      const logoutBtn = document.getElementById('logoutBtn');

      const tokenStore = {
        accessToken: localStorage.getItem('access_token') || '',
        refreshToken: localStorage.getItem('refresh_token') || ''
      };

      function decodeJwt(token) {
        try {
          const payload = token.split('.')[1];
          const json = atob(payload.replace(/-/g, '+').replace(/_/g, '/'));
          return JSON.parse(decodeURIComponent(escape(json)));
        } catch (error) {
          return null;
        }
      }

      function resolveNickname(token) {
        const payload = decodeJwt(token) || {};
        return payload.preferred_username || payload.name || payload.sub || 'user';
      }

      function setStatus(text) {
        statusEl.textContent = `Статус: ${text}`;
      }

      function renderMessage({ author, content, timestamp }) {
        const item = document.createElement('div');
        item.className = 'message';
        const time = new Date(timestamp).toLocaleTimeString();
        item.innerHTML = `
          <div>${author}: ${content}</div>
          <div class="meta">${time}</div>
        `;
        messagesEl.appendChild(item);
        messagesEl.scrollTop = messagesEl.scrollHeight;
      }

      function renderParticipants(list) {
        participantsEl.innerHTML = '';
        list.forEach((name) => {
          const item = document.createElement('div');
          item.textContent = name;
          participantsEl.appendChild(item);
        });
      }

      const ChatSocketService = (function () {
        const maxReconnectAttempts = 5;
        const baseDelay = 1000;
        let reconnectAttempts = 0;
        let stompClient = null;
        let sock = null;
        let connecting = false;
        let manualClose = false;

        function connect() {
          if (connecting || manualClose) {
            return;
          }
          connecting = true;
          setStatus('подключение...');
          sock = new SockJS('/ws');
          stompClient = Stomp.over(sock);
          stompClient.debug = null;

          const headers = {
            Authorization: `Bearer ${tokenStore.accessToken}`
          };

          sock.onclose = (event) => {
            if (manualClose) {
              return;
            }
            if (event && event.code === 1008) {
              handleAuthError();
              return;
            }
            scheduleReconnect();
          };

          stompClient.connect(
            headers,
            () => {
              connecting = false;
              reconnectAttempts = 0;
              setStatus('подключено');
              stompClient.subscribe('/topic/chat', (message) => {
                const body = JSON.parse(message.body);
                renderMessage(body);
              });
              stompClient.subscribe('/topic/participants', (message) => {
                const list = JSON.parse(message.body);
                renderParticipants(list);
              });
            },
            (errorFrame) => {
              connecting = false;
              const errorMessage = errorFrame && errorFrame.headers && errorFrame.headers.message;
              if (errorMessage && errorMessage.toLowerCase().includes('unauthorized')) {
                handleAuthError();
                return;
              }
              scheduleReconnect();
            }
          );
        }

        function scheduleReconnect() {
          if (reconnectAttempts >= maxReconnectAttempts) {
            setStatus('ошибка подключения');
            return;
          }
          const delay = baseDelay * Math.pow(2, reconnectAttempts);
          reconnectAttempts += 1;
          setStatus(`переподключение через ${delay / 1000}с`);
          setTimeout(connect, delay);
        }

        function disconnect() {
          manualClose = true;
          if (stompClient) {
            stompClient.disconnect(() => {
              setStatus('отключено');
            });
          }
        }

        function sendMessage(content, author) {
          if (!stompClient || !stompClient.connected) {
            setStatus('нет соединения');
            return;
          }
          const payload = {
            author,
            content,
            timestamp: new Date().toISOString()
          };
          try {
            stompClient.send('/app/chat.send', {}, JSON.stringify(payload));
          } catch (error) {
            handleAuthError();
          }
        }

        function handleAuthError() {
          setStatus('обновление токена');
          refreshToken()
            .then((newToken) => {
              tokenStore.accessToken = newToken;
              localStorage.setItem('access_token', newToken);
              manualClose = false;
              connect();
            })
            .catch(() => {
              setStatus('нужно перелогиниться');
            });
        }

        function refreshToken() {
          return fetch('/auth/refresh', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ refreshToken: tokenStore.refreshToken })
          })
            .then((response) => {
              if (!response.ok) {
                throw new Error('Refresh failed');
              }
              return response.json();
            })
            .then((data) => {
              return data.accessToken || data.token || '';
            });
        }

        function clearTokens() {
          tokenStore.accessToken = '';
          tokenStore.refreshToken = '';
          localStorage.removeItem('access_token');
          localStorage.removeItem('refresh_token');
        }

        return {
          connect,
          disconnect,
          sendMessage,
          clearTokens
        };
      })();

      const nickname = resolveNickname(tokenStore.accessToken);
      nicknameEl.textContent = nickname;

      messageForm.addEventListener('submit', (event) => {
        event.preventDefault();
        const content = messageInput.value.trim();
        if (!content) {
          return;
        }
        ChatSocketService.sendMessage(content, nickname);
        messageInput.value = '';
      });

      logoutBtn.addEventListener('click', () => {
        ChatSocketService.disconnect();
        ChatSocketService.clearTokens();
        setStatus('отключено');
      });

      ChatSocketService.connect();
    })();
  </script>
</body>
</html>
